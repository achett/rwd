# Function to project a population from truven onto US population. Stolen from Stephen Stanhope's MO.
# Inputs: 
    # Arguement 1: Dataframe with cohort of patients and ages
    # Arguement 2: list of age range
# Output: Dataframe with projections by gemder

# Disclaimer1: This is made for 2014 data. If a different year's data is used then data for Step 3 (Truven population in 2014) taken from dataset, 
    # and data for step 6.1 (US Census figures for 2014) need to be updated for approrprate year.
# Disclaimer2: If a different dataset is used then data for Step 3 (Truven population in 2014) needs to be updated.


# Example: 
#dat.incl <- fread('/rwi/users/sstanhope/MarketOverview/DataFiles_03062017/population_14_costs.csv',header=TRUE,integer64='character',colClasses=c(rep('numeric',5),'logical',rep('numeric',44)))
#age.inclusion=c(0,100)
#x=us_projections(dat.incl, age.inclusion)

us_projections<-function(dat.incl, age.inclusion)

{

ind <- (dat.incl$age >= age.inclusion[1]) & (dat.incl$age <= age.inclusion[2])
dat.incl <- dat.incl[ind,]

# Step 1 - Calculate raw age / sex population counts and prevalences. Plot age / gender distribution of included patients. 
age <- age.inclusion[1]:age.inclusion[2]    # note that age 100 is really age 100+

# Step 2 - Get the number of patients by age for each sex.

incl.m <- rep(0,NROW(age))
for (i in 1:NROW(age)) incl.m[i] <- sum(dat.incl$age==age[i] & dat.incl$sex==1)
if (age.inclusion[2]==100) incl.m[NROW(age)] <- sum(dat.incl$age>=100 & dat.incl$sex==1)

incl.f <- rep(0,NROW(age))
for (i in 1:NROW(age)) incl.f[i] <- sum(dat.incl$age==age[i] & dat.incl$sex==2)
if (age.inclusion[2]==100) incl.f[NROW(age)] <- sum(dat.incl$age>=100 & dat.incl$sex==2)

# Step 3 - Specify the number of persons in the MO population by age and sex.

n.m <- c(206137,135964,102918,110159,117440,124899,132119,137743,140178,146352,151454,151147,156207,163763,165052,169544,172172,175929,177436,175838,
         172644,171567,163103,154705,143505,133725,57290,69809,85366,92411,99809,109243,114974,121866,126051,128139,135076,134395,138792,145711,147774,
         156240,170385,179481,174753,171043,171901,175752,182734,194516,197955,199577,203323,205131,205890,204810,207993,204419,199649,200048,191671,
         189680,182867,172485,163490,91176,109034,77366,62925,62930,64868,62164,53985,49533,45781,45835,42360,38867,37226,35782,32908,32072,30077,28425,
         25252,22821,20584,17501,14730,12657,10294,8051,6706,4640,3012,2381,1519,999,646,430,652)
n.f <- c(206137,135964,102918,110159,117440,124899,132119,137743,140178,146352,151454,151147,156207,163763,165052,169544,172172,175929,177436,175838,
         172644,171568,163099,154705,143506,133725,57291,69809,85366,92413,99808,109241,114974,121870,126049,128137,135072,134394,138787,145705,147772,
         156235,170379,179473,174747,171010,171861,175739,182711,194486,197875,199537,203306,205138,205835,204721,207876,204380,199591,199995,191471,
         189522,182611,172157,162801,99365,116187,82555,67780,67518,70590,67353,59532,54711,52684,52535,50125,46644,45737,43622,40301,39684,38024,37017,
         34563,32434,30345,26655,23687,21353,17680,14876,12955,9913,7096,5704,4179,2941,1994,1431,2587)

n.m <- n.m[(age.inclusion[1]+1):(age.inclusion[2]+1)]
n.f <- n.f[(age.inclusion[1]+1):(age.inclusion[2]+1)]

# Step 4 - Calculate raw patient totals and prevalences.

raw.total.m <- sum(incl.m)
raw.total.f <- sum(incl.f)
raw.total <- raw.total.m + raw.total.f
raw.prevalence.m <- raw.total.m / sum(n.m)
raw.prevalence.f <- raw.total.f / sum(n.f)
raw.prevalence <- raw.total / (sum(n.m) + sum(n.f))

# Step 5 - Calculate patient prevalences by age / sex. For each sex, smooth the raw age prevalences by using a smoothing spline. 

prop.m <- incl.m / n.m
prop.m[is.nan(prop.m)] <- 0
mod <- smooth.spline(age,prop.m,cv=TRUE)
prop.m.smooth <- predict(mod)$y
prop.m.smooth[prop.m.smooth < 0] <- 0
prop.f <- incl.f / n.f
prop.f[is.nan(prop.f)] <- 0
mod <- smooth.spline(age,prop.f,cv=TRUE)
prop.f.smooth <- predict(mod)$y
prop.f.smooth[prop.f.smooth < 0] <- 0


# Step 6 - Do US population projections. Generate plots and provide raw counts. Update depending on the year you select

print('Projecting age / sex disease prevalences onto the US population.')

# Step 6.1 - Provide age / sex US population numbers. These are from the US census. Update depending on the year you select, this is for 2014.

n.male.usa.2014 <- c(2031919,2024845,2030157,2047456,2042466,2042212,2109358,2121977,2105421,2097828,2100616,2084117,2075355,2128156,2164172,2129032,2131656,2139062,2164804,2219859,
                     2270151,2311112,2369229,2402267,2395949,2302130,2246393,2206844,2213366,2223768,2145293,2173827,2168970,2142241,2193355,2048743,2006140,1980169,1923153,1985687,
                     1915813,1938964,2029906,2146087,2182193,2065134,2020074,2015928,2054996,2176702,2208618,2202580,2196310,2218427,2241372,2157478,2140525,2110244,2028068,2007286,
                     1914614,1837717,1764760,1702953,1661323,1609052,1592863,1656881,1210817,1186618,1150601,1172169,1011794,913174,857416,803367,758271,689623,648866,610338,539736,
                     510821,477047,442682,411649,359765,323380,283531,240485,205698,170356,137942,109886,85752,62077,42528,31075,20391,13557,8934,13133)
n.female.usa.2014 <- c(1939928,1933019,1941924,1955816,1959463,1960765,2023097,2030676,2013207,2007948,2013208,1999357,1990699,2038164,2065487,2033092,2034973,2044101,2057632,2102178,
                       2146302,2176351,2241234,2294579,2296491,2208572,2162019,2128046,2140957,2165936,2106937,2144748,2149396,2130303,2165138,2041384,2004078,1989912,1931202,1988757,
                       1935588,1972415,2059589,2179934,2199462,2089714,2049025,2058376,2096457,2225392,2276447,2280045,2279410,2313739,2329740,2261793,2253669,2236541,2163714,2148502,
                       2071851,1997755,1922903,1870539,1825793,1777315,1760799,1834277,1359937,1346338,1318379,1352220,1183698,1088408,1031799,970054,934982,866379,831401,802816,723658,
                       704463,676286,647736,624666,565616,532756,487498,435594,394561,342975,289389,245393,200852,157183,114526,90261,63710,46757,33053,57211)
n.male.usa.2014 <- n.male.usa.2014[(age.inclusion[1]+1):(age.inclusion[2]+1)]
n.female.usa.2014 <- n.female.usa.2014[(age.inclusion[1]+1):(age.inclusion[2]+1)]

n.male.usa.2020 <- c(2112227,2110124,2106208,2099971,2091645,2082151,2072106,2061655,2064352,2079870,2074865,2074610,2141681,2154506,2138823,2133750,2141545,2133148,2136548,2204170, 
                     2255238,2235286,2249956,2265079,2294255,2347975,2395006,2430306,2480809,2507296,2493127,2393397,2329773,2283168,2281420,2284025,2200068,2221154,2212514,2180874, 
                     2225360,2078234,2030233,1999892,1938571,1994547,1921478,1938366,2023363,2131770,2160937,2040602,1989457,1980083,2010893,2121564,2145331,2132021,2119110,2132596, 
                     2145722,2058424,2034136,1997379,1911761,1883480,1788094,1706708,1628871,1560232,1509382,1449616,1421092,1461926,1057750,1022425,976733,977962,828704,732256,671105, 
                     612234,560560,492781,446125,401983,338889,303894,267502,232394,201048,162418,133916,106861,81954,62820,46324,33131,23091,15648,19999)
n.female.usa.2020 <- c(2016583,2014769,2011338,2005982,1998821,1990780,1982117,1972358,1978369,1990296,1992755,1993422,2055067,2062790,2046306,2043372,2053324,2046530,2047914,2107498, 
                       2148292,2129154,2142414,2160124,2179280,2226200,2269803,2298124,2359196,2407392,2402895,2307622,2252477,2209941,2214009,2230370,2164701,2196181,2196315,2173512,
                       2204441,2078337,2037223,2019257,1956508,2008911,1952043,1984201,2067063,2182324,2197770,2086060,2041966,2048199,2081903,2204480,2250839,2250455,2246344,2275849, 
                       2286808,2216521,2203745,2181429,2104851,2082753,2001203,1921310,1840576,1780332,1726881,1669655,1641491,1695235,1248587,1223013,1183826,1197857,1034074,935639,
                       870627,801905,755047,681641,634809,592443,513958,478819,437679,396671,359763,304408,266029,224136,183030,150152,117147,88036,65831,47087,69469)
n.male.usa.2020 <- n.male.usa.2020[(age.inclusion[1]+1):(age.inclusion[2]+1)]
n.female.usa.2020 <- n.female.usa.2020[(age.inclusion[1]+1):(age.inclusion[2]+1)]

n.male.usa.2025 <- c(2141790,2147153,2151437,2153453,2152839,2149418,2143563,2136115,2127808,2118628,2109255,2099593,2089482,2092644,2109126,2106867,2112077,2188314,2214149,2213726,
                     2223862,2244807,2245650,2253851,2321969,2370273,2345637,2354212,2362788,2385211,2431955,2472123,2500282,2543044,2562606,2542064,2437241,2368800,2318432,2312667,
                     2311057,2223750,2239773,2227101,2190986,2230104,2080725,2029205,1995304,1930369,1980630,1904205,1915605,1993955,2094828,2117823,1995523,1940174,1925872,1949706, 
                     2050183,2066924,2047800,2029223,2035167,2039402,1948515,1916284,1871230,1780282,1741931,1641936,1554744,1470656,1394344,1333444,1264742,1222266,1237336,880056,
                     833254,777826,758818,624675,534275,472011,413368,361620,302315,258901,219598,173267,144450,117531,93696,73940,54114,40143,28653,19562,28700)
n.female.usa.2025 <- c(2044786,2050067,2054470,2056987,2057236,2055010,2050344,2043927,2036437,2027974,2019187,2010061,2000078,2006286,2019315,2024477,2030088,2099206,2117299,2113178,
                       2123069,2144767,2147202,2154851,2217385,2258615,2238032,2248683,2262484,2276665,2317480,2353794,2374365,2426998,2467228,2455676,2354817,2295381,2249761,2251035,
                       2264537,2196214,2223881,2220083,2193401,2220007,2091462,2047360,2026765,1961821,2010805,1951754,1980511,2059805,2170694,2183017,2070647,2024425,2028261,2058378,
                       2175078,2217022,2212621,2204082,2227125,2230812,2155488,2134886,2104141,2021022,1989422,1901131,1814137,1726282,1656792,1593212,1525643,1483575,1513171,1100618, 
                       1061044,1009031,1000792,845179,745631,674116,601006,545284,472360,420066,372511,305457,267312,228096,191640,160092,123841,98215,74529,54452,90681)
n.male.usa.2025 <- n.male.usa.2025[(age.inclusion[1]+1):(age.inclusion[2]+1)]
n.female.usa.2025 <- n.female.usa.2025[(age.inclusion[1]+1):(age.inclusion[2]+1)]

n.male.usa.2030 <- c(2151367,2160085,2168189,2174450,2178598,2180999,2182290,2182813,2182593,2181066,2177715,2172209,2165079,2157143,2149094,2142414,2138499,2138146,2155017,2187498,
                     2201354,2220553,2306547,2337479,2338064,2345779,2361827,2356369,2357841,2418798,2459971,2428299,2429508,2430661,2445768,2485577,2519765,2542767,2580846,2596292,
                     2571650,2463128,2390219,2335537,2325098,2318842,2228451,2240026,2223693,2183425,2216699,2064788,2009149,1971146,1902827,1947094,1868016,1874013,1945066,2037516,
                     2053917,1930682,1871642,1852484,1868935,1957569,965423,1938048,1910438,1904526,1895376,1798279,1754681,1698252,1600013,1548231,1441842,1346728,1254352,1168441,
                     1095289,1015930,957452,942320,649502,593380,532288,496666,389347,315513,262744,215633,175737,135992,107107,82994,59432,44654,32539,23070,35253)
n.female.usa.2030 <- c(2053928,2062378,2070423,2076997,2081791,2085090,2087296,2088540,2088800,2087646,2084622,2079463,2072840,2065568,2058248,2052197,2048174,2046077,2063077,2088973,
                       2107598,2125590,2204353,2229111,2228365,2238742,2258979,2258596,2262255,2319455,2354334,2326293,2328721,2334004,2340125,2373663,2403913,2420041,2468931,2506185,
                       2491863,2388210,2325375,2276047,2273149,2282551,2211106,2235258,2228554,2199322,2222659,2092737,2046238,2023338,1956737,2002526,1942007,1967805,2043476,2149701,
                       2158863,2046071,1997269,1997380,2021790,2129043,2162706,2150312,2133226,2145329,2137660,2054543,2022650,1980155,1887966,1842967,1745030,1647902,1549809,1467533,
                       1389803,1308201,1247934,1245594,884596,829334,764260,731400,593645,501006,431206,364055,310977,252127,208468,170760,128430,102304,78877,59401,103158)
n.male.usa.2030 <- n.male.usa.2030[(age.inclusion[1]+1):(age.inclusion[2]+1)]
n.female.usa.2030 <- n.female.usa.2030[(age.inclusion[1]+1):(age.inclusion[2]+1)]

n.male.usa.2040 <- c(2187724,2192766,2197508,2201052,2203552,2205506,2207602,2210299,2213847,2217999,2222703,2227366,2231815,2236093,2240435,2245789,2253585,2264951,2279788,2296654,
                     2313456,2329131,2343167,2355310,2365188,2372919,2378736,2382382,2397659,2423866,2428324,2435302,2506665,2522643,2508685,2502315,2504775,2486423,2475879,2524896,
                     2554488,2512550,2503893,2496056,2502126,2532582,2557994,2572072,2600080,2605987,2572160,2456581,2375786,2313783,2294523,2278658,2181951,2182815,2158081,2109587,
                     2130336,1976662,1914278,1868732,1794866,1825074,1740806,1733336,1784375,1852399,1849057,1720853,1647877,1609378,1598414,1645387,1621612,1566259,1508897,1465397, 
                     1415108,1298938,1221237,1133257,1018654,934767,820655,717521,620766,532577,455833,382528,322716,281131,169639,134036,102663,80707,52672,35067,52026)
n.female.usa.2040 <- c(2088621,2093505,2098273,2102236,2105484,2108454,2111446,2114814,2118692,2122994,2127626,2132189,2136656,2141068,2145578,2150924,2158045,2167520,2179539,2193344,
                       2207546,2220928,2233107,2244244,2253990,2262597,2270018,2275207,2294905,2318717,2331362,2340072,2406876,2418533,2403943,2400112,2406419,2392657,2383999,2429518,
                       2454007,2416882,2411054,2408708,2407810,2434416,2457606,2467072,2508290,2538081,2517010,2408308,2340439,2286601,2278568,2282674,2207657,2226053,2214503,2181249,
                       2198665,2068244,2017902,1990293,1919844,1956084,1889909,1904470,1965166,2051923,2045086,1924090,1860668,1841898,1842233,1913588,1916229,1875352,1827976,1802047,
                       1754885,1644549,1573682,1491980,1372180,1286017,1163263,1043369,926232,821687,723653,628225,547470,494210,314211,260698,210011,173445,119980,85119,140922)
n.male.usa.2040 <- n.male.usa.2040[(age.inclusion[1]+1):(age.inclusion[2]+1)]
n.female.usa.2040 <- n.female.usa.2040[(age.inclusion[1]+1):(age.inclusion[2]+1)]

n.male.usa.2050 <- c(2260314,2264273,2267319,2268549,2268320,2267173,2265776,2264560,2263774,2263379,2263532,2263958,2264683,2266011,2268612,2273608,2282485,2296498,2315858,2339346,
                     2365335,2392475,2419478,2445260,2468926,2489941,2508457,2524468,2537972,2548626,2555662,2558623,2558013,2554648,2549098,2542203,2534061,2524429,2527260,2541592,
                     2534882,2531272,2592245,2598941,2576449,2561620,2555743,2529030,2510007,2549545,2569658,2519765,2502896,2486992,2484273,2504737,2520190,2524266,2541217,2537085,
                     2494266,2373497,2285981,2217171,2188532,2161908,2059500,2046576,2009811,1949312,1949912,1792677,1717011,1655271,1567946,1568833,1471276,1436224,1446458,1465195,
                     1422254,1283230,1185703,1113369,1057446,1035607,965589,876437,788042,708675,628226,524959,444890,368095,291760,233329,176374,131055,95090,67539,106489)
n.female.usa.2050 <- c(2157897,2161673,2164755,2166541,2167172,2167164,2166838,2166477,2166273,2166245,2166580,2167170,2168076,2169654,2172497,2177505,2185594,2197515,2213722,2233760,
                       2256554,2280694,2305088,2329112,2351842,2372884,2392320,2409826,2424899,2436759,2444707,2448351,2448351,2445682,2440805,2434588,2427394,2418627,2425472,2437571,
                       2439711,2439032,2496973,2500952,2479408,2468794,2468517,2448066,2432689,2470772,2488482,2445748,2434455,2427042,2421375,2442909,2460808,2465594,2501121,2525531,
                       2500199,2389448,2318397,2260734,2246633,2243174,2162437,2170139,2147845,2103649,2105307,1967494,1903390,1859661,1775344,1786444,1703655,1690617,1715423,1757435,
                       1714377,1575135,1482256,1424006,1376307,1375562,1319657,1230796,1136858,1055033,960377,835248,735260,635286,527181,441091,352202,275442,210531,158693,280130)
n.male.usa.2050 <- n.male.usa.2050[(age.inclusion[1]+1):(age.inclusion[2]+1)]
n.female.usa.2050 <- n.female.usa.2050[(age.inclusion[1]+1):(age.inclusion[2]+1)]

proj.m.2014 <- n.male.usa.2014*prop.m
proj.f.2014 <- n.female.usa.2014*prop.f
proj.m.smooth.2014 <- n.male.usa.2014*prop.m.smooth
proj.f.smooth.2014 <- n.female.usa.2014*prop.f.smooth


# Step 4.3 - Use the 2014 US patient populations by age / sex to get total 2014 US patient population estimates.

proj.total.2014 <- sum(proj.m.2014) + sum(proj.f.2014)
proj.total.m.smooth.2014 <- sum(proj.m.smooth.2014)
proj.total.f.smooth.2014 <- sum(proj.f.smooth.2014)
proj.total.smooth.2014 <- proj.total.m.smooth.2014 + proj.total.f.smooth.2014

# Step 4.4 - Get total US patient population estimates for 2020-2050.

proj.m.smooth.2020 <- n.male.usa.2020*prop.m.smooth
proj.f.smooth.2020 <- n.female.usa.2020*prop.f.smooth
proj.total.m.smooth.2020 <- sum(proj.m.smooth.2020)
proj.total.f.smooth.2020 <- sum(proj.f.smooth.2020)
proj.total.smooth.2020 <- proj.total.m.smooth.2020 + proj.total.f.smooth.2020

proj.m.smooth.2025 <- n.male.usa.2025*prop.m.smooth
proj.f.smooth.2025 <- n.female.usa.2025*prop.f.smooth
proj.total.m.smooth.2025 <- sum(proj.m.smooth.2025)
proj.total.f.smooth.2025 <- sum(proj.f.smooth.2025)
proj.total.smooth.2025 <- proj.total.m.smooth.2025 + proj.total.f.smooth.2025

proj.m.smooth.2030 <- n.male.usa.2030*prop.m.smooth
proj.f.smooth.2030 <- n.female.usa.2030*prop.f.smooth
proj.total.m.smooth.2030 <- sum(proj.m.smooth.2030)
proj.total.f.smooth.2030 <- sum(proj.f.smooth.2030)
proj.total.smooth.2030 <- proj.total.m.smooth.2030 + proj.total.f.smooth.2030

proj.m.smooth.2040 <- n.male.usa.2040*prop.m.smooth
proj.f.smooth.2040 <- n.female.usa.2040*prop.f.smooth
proj.total.m.smooth.2040 <- sum(proj.m.smooth.2040)
proj.total.f.smooth.2040 <- sum(proj.f.smooth.2040)
proj.total.smooth.2040 <- proj.total.m.smooth.2040 + proj.total.f.smooth.2040

proj.m.smooth.2050 <- n.male.usa.2050*prop.m.smooth
proj.f.smooth.2050 <- n.female.usa.2050*prop.f.smooth
proj.total.m.smooth.2050 <- sum(proj.m.smooth.2050)
proj.total.f.smooth.2050 <- sum(proj.f.smooth.2050)
proj.total.smooth.2050 <- proj.total.m.smooth.2050 + proj.total.f.smooth.2050

x=data.frame(age)
x$proj_m_year1=proj.m.2014
x$proj_f_year1=proj.f.2014

x$proj_m_2020=proj.m.smooth.2020
x$proj_f_2020=proj.f.smooth.2020

x$proj_m_2025=proj.m.smooth.2025
x$proj_f_2025=proj.f.smooth.2025

x$proj_m_2030=proj.m.smooth.2030
x$proj_f_2030=proj.f.smooth.2030

x$proj_m_2040=proj.m.smooth.2040
x$proj_f_2040=proj.f.smooth.2040

x$proj_m_2050=proj.m.smooth.2050
x$proj_f_2050=proj.f.smooth.2050

return(x)

}




